name: CI-CD - Container Health app 

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      deploy:
        description: "Deploy image and apply kubernetes manifests"
        required: true
        default: "false"

permissions:
  contents: read
  packages: write

jobs:
  build:
    name: Build and test image
    runs-on: ubuntu-latest
    
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image (CI)
        run: |
          docker build \
            -t container-health:ci \
            ./app
          
      - name: Run container for healthcheck
        run: |
          docker run --rm -d -p 8000:8000 --name container-health-ci container-health:ci
          sleep 5


      - name: Validate /health endpoint
        run: |
          curl --fail http://localhost:8000/health

      - name: Stop container
        run: |
          docker stop container-health-ci
    
  release:
    env:
      IMAGE_NAME: ghcr.io/brucie83/container-health
    name: Release Image (Manual)
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.deploy == 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Github Container Registry
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Calculate next version (SemVer PATCH)
        run: |
          OLD=$(cat VERSION)
          IFS='.' read -r M m p <<< "$OLD"
          NEW="$M.$m.$((p+1))"
          echo "$NEW" > VERSION
          echo "VERSION=$NEW" >> $GITHUB_ENV
          
      
      - name: Build Image
        run: |
          docker build \
            -t $IMAGE_NAME:{{ env.VERSION }} \
            -t $IMAGE_NAME:sha-${{ github.sha }} \
            ./app
    
      - name: Push image to GHCR
        run: |
          docker push $IMAGE_NAME:{{ env.VERSION }}
          docker push $IMAGE_NAME:sha-${{ github.sha }}


      - name: COmmit VERSION bump
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add VERSION
          git commit -m "chore: release v$VERSION"  || echo "No changes to commit" 
          git push