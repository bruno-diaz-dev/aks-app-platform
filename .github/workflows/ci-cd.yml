name: CI-CD - Container Health Platform

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment to promote
        required: true
        type: choice
        options:
          - dev
          - stage
          - prod
      image_tag:
        description: Image tag to promote (e.g. sha-abcdef)
        required: true

permissions:
  contents: write
  packages: write
  id-token: write

concurrency:
  group: ci-cd-container-health
  cancel-in-progress: true

env:
  IMAGE_NAME: ghcr.io/bruno-diaz-dev/container-health

# -----------------------------
# CI — build once
# -----------------------------
jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run tests
        run: echo "ok"

  build:
    name: Build, scan and push image
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} \
            | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build image (single source of truth)
        run: |
          docker build \
            -t $IMAGE_NAME:sha-${{ github.sha }} \
            ./app

      - name: Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: $IMAGE_NAME:sha-${{ github.sha }}
          severity: CRITICAL,HIGH
          exit-code: 1

      - name: Push image to GHCR
        run: |
          docker push $IMAGE_NAME:sha-${{ github.sha }}

# -----------------------------
# RELEASE — promotion only
# -----------------------------
  release:
    name: Promote image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch'
    environment: ${{ inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Validate image tag exists
        run: |
          docker manifest inspect \
            $IMAGE_NAME:${{ inputs.image_tag }}

      - name: Promote image via GitOps
        run: |
          echo "Promoting $IMAGE_NAME:${{ inputs.image_tag }} to ${{ inputs.environment }}"

          echo "${{ inputs.image_tag }}" \
            > platform/apps/container-health/${{ inputs.environment }}/image-tag.txt

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add platform/apps/container-health/${{ inputs.environment }}/image-tag.txt
          git commit -m "chore(release): promote container-health to ${{ inputs.environment }} (${{
            inputs.image_tag }})"
          git push

      - name: Deployment summary
        run: |
          {
            echo "## Promotion Summary"
            echo ""
            echo "- Environment: **${{ inputs.environment }}**"
            echo "- Image: \`${IMAGE_NAME}:${{ inputs.image_tag }}\`"
            echo "- Commit: \`${{ github.sha }}\`"
            echo "- Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          } >> $GITHUB_STEP_SUMMARY
