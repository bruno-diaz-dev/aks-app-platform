trigger:
- main

pool:
  name: local-linux

variables:
- group:  ghcr-secrets
- name: IMAGE_NAME
  value: ghcr.io/brucie83/container-health

steps:
- script: |
    echo "Login to GHCR"
    docker login ghcr.io -u "$(GHCR_USERNAME)" -p "$(GHCR_TOKEN)"
  displayName: "Docker login to GHCR"

- script: |
    echo "Build image"
    docker build \
      -f app/Dockerfile \
      -t $(IMAGE_NAME):$(Build.BuildId) \
      app
  displayName: "Docker build"

- script: |
    echo "Installing Trivy"
    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
      | sh -s -- -b /usr/local/bin
  displayName: "Install Trivy"

- script: |
    echo "Running Trivy image scan"
    trivy image \
      --severity HIGH,CRITICAL\
      --exit-code 1 \
      --no-progress \
      $(IMAGE_NAME):(Build.BuildId)
  displayName: "Trivy scan image"

- script: |
    echo "Push image"
    docker push $(IMAGE_NAME):$(Build.BuildId)
  displayName: "Docker push"